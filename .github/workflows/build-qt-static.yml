name: Build Static Qt LTS
on: [push]

jobs:
  build-static-Qt:
    name: build static Qt
    runs-on: windows-2022

    steps:
      - name: Install vs2019 toolset
        shell: pwsh
        run: |
          echo "Download vs_enterprise.exe for VS2019 (version 16)"
              Invoke-WebRequest -Uri "https://aka.ms/vs/16/release/vs_enterprise.exe" -OutFile "vs_enterprise.exe" -UseBasicParsing

              echo "Install VS2019 with required components"

              $process = Start-Process -FilePath "./vs_enterprise.exe" -ArgumentList @(
                  "install",
                  "--installPath", "C:\VS2019",
                  "--add", "Microsoft.VisualStudio.Component.VC.140",
                  "--add", "Microsoft.VisualStudio.Component.VC.ATLMFC",
                  "--add", "Microsoft.VisualStudio.Component.VC.CLI.Support",
                  "--add", "Microsoft.VisualStudio.Component.VC.ATLMFC.Spectre",
                  "--add", "Microsoft.VisualStudio.Component.VC.Redist.MSM",
                  "--add", "Microsoft.VisualStudio.Component.VC.v141.x86.x64",
                  "--add", "Microsoft.VisualStudio.Component.VC.v141.x86.x64.Spectre",
                  "--add", "Microsoft.VisualStudio.Component.VC.v141.ATL",
                  "--add", "Microsoft.VisualStudio.Component.VC.v141.MFC",
                  "--add", "Microsoft.VisualStudio.Component.VC.v141.MFC.Spectre",
                  "--add", "Microsoft.VisualStudio.Component.VC.14.25.x86.x64",
                  "--add", "Microsoft.VisualStudio.Component.Windows10SDK.19041",
                  "--passive", "--norestart"
              ) -Wait -PassThru 

              Write-Output "VS2019安装程序退出代码: $($process.ExitCode)"

              Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio\"
              Get-ChildItem -Path "C:\Program Files (x86)\Microsoft Visual Studio\"
              Get-ChildItem -Path "C:\"
              Get-ChildItem -Path "C:\VS2019\VC\Tools\MSVC\"

              if (-not (Test-Path "C:\VS2019\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64\cl.exe")) {
                throw "MSVC 142工具集安装失败，未找到编译器cl.exe"
              }
              echo "VS2019及所需组件安装完成"
      - name: Set toolset v142
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: "x64"
          toolset: "14.29.30133"
          vs-path: "C:\\VS2019"