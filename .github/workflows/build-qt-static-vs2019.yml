name: Build Static Qt 6 LTS (Release+Debug) for VS 2019

on:
  workflow_dispatch:  # 手动触发
  push:
    tags:
      - 'v*'          # 标签触发（例如 v6.8.3）

env:
  QT_VERSION: '6.8.3' # Qt 6 最新 LTS 版本（截至2025年8月）
  INSTALL_DIR: 'C:\Qt\%QT_VERSION%-msvc2019-static'
  BUILD_DIR: 'qt-build'

jobs:
  build-windows:
    runs-on: windows-2019  # 预装 VS 2019 和 Ninja

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        choco install -y python --version=3.11.0  # Qt 6 需要 Python 3
        choco install -y 7zip
        set PATH=C:\Python311;%PATH%

    - name: Download Qt Sources
      shell: cmd
      run: |
        curl -L -o qt-src.zip https://download.qt.io/official_releases/qt/%QT_VERSION%.split('/')[0]/%QT_VERSION%/single/qt-everywhere-src-%QT_VERSION%.zip
        7z x qt-src.zip -oqt-src

    - name: Configure Qt (Release+Debug)
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        mkdir %BUILD_DIR%
        cd %BUILD_DIR%
        ..\qt-src\configure.bat ^
          -static ^
          -prefix "%INSTALL_DIR%" ^
          -platform win32-msvc ^
          -debug-and-release  # 同时编译 Release 和 Debug
          -nomake examples ^
          -nomake tests ^
          -skip qtwebengine ^  # 跳过耗时模块
          -skip qtwebview ^
          -skip qt3d ^
          -opensource ^
          -confirm-license ^
          -cmake-generator "Ninja" ^
          -mp  # 启用多进程编译

    - name: Build Qt
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cd %BUILD_DIR%
        ninja -j %NUMBER_OF_PROCESSORS%  # 使用所有 CPU 核心

    - name: Install Qt
      shell: cmd
      run: |
        cd %BUILD_DIR%
        ninja install

    - name: Package Qt
      shell: cmd
      run: |
        7z a -t7z -mx9 qt-%QT_VERSION%-msvc2019-static.7z "%INSTALL_DIR%"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: qt-%QT_VERSION%-msvc2019-static
        path: qt-%QT_VERSION%-msvc2019-static.7z

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: qt-%QT_VERSION%-msvc2019-static.7z
        tag_name: ${{ github.ref_name }}
        name: Qt ${{ env.QT_VERSION }} LTS Static (VS 2019)
        body: |
          Static Qt ${{ env.QT_VERSION }} LTS (Release+Debug) for Visual Studio 2019.
          Built on GitHub Actions (${{ github.run_id }}).
          Modules included: Core, GUI, Widgets, Network, Concurrency.
          Skipped: WebEngine, 3D, Multimedia.